<html>
  <head>
    <title>Estimation frais de port</title>
    <script>
      function init() {
        document.querySelectorAll('form input').forEach( input => { 
          input.onchange= (event) => { document.querySelector('form').submit(); }; 
        });
        fetch("data/tarif.json").then(async j => {
          const tarifs = await j.json();
          document.querySelector("form").submit=(event) => {
            const length = parseFloat(document.querySelector("input#length").value);
            const width = parseFloat(document.querySelector("input#width").value);
            const height = parseFloat(document.querySelector("input#height").value);
            const weight = parseFloat(document.querySelector("input#weight").value);
            const result = [];
            tarifs
              .filter(t => { return ! t.r || ( ( t.r.maxL     === undefined || t.r.maxL     >= length ) 
                                            && ( t.r.minL     === undefined || t.r.minL     < length ) 
                                            && ( t.r.maxW     === undefined || t.r.maxW     >= width  ) 
                                            && ( t.r.minW     === undefined || t.r.minW     < width  ) 
                                            && ( t.r.maxH     === undefined || t.r.maxH     >= height )
                                            && ( t.r.minH     === undefined || t.r.minH     < height ) 
                                            && ( t.r.maxLWH   === undefined || t.r.maxLWH   >= length + width + height )
                                            && ( t.r.minLWH   === undefined || t.r.minLWH   < length + width + height )
                                            && ( t.r.minL2W2H === undefined || t.r.minL2W2H < length + (2 * width) + (2 * height) ) ); })
              .forEach(offre => {
                const best = offre.t.find( t => { for( p in t ) { if( p >= weight ) { return true; } } });
                for( p in best ) { 
                  result.push({ "n" : offre.n, "h": offre.h, "t": best[p], "a": offre.a ? (offre.a.f ? offre.a.f : offre.a.r * p / 1000 ) : 0 });
                }
              });
            const domArray = document.querySelector("tbody");
            while(domArray.hasChildNodes()) { domArray.removeChild(domArray.firstChild); }
            result
              .sort( (a,b) => { return a.t - b.t; })
              .forEach(t => {
                const tr = document.createElement("tr");
                const td1 = document.createElement("td");
                td1.appendChild(document.createTextNode(t.n));
                tr.appendChild(td1);
                const td2 = document.createElement("td");
                td2.appendChild(document.createTextNode(t.h?"ðŸ ":"ðŸª"));
                tr.appendChild(td2);
                const td3 = document.createElement("td");
                td3.appendChild(document.createTextNode(Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(t.t)));
                tr.appendChild(td3);
                const td4 = document.createElement("td");
                if(t.a > 0 ) { td4.appendChild(document.createTextNode(Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(t.a))); }
                tr.appendChild(td4);
                domArray.appendChild(tr);
              });
          };
        });
      }
    </script>
    <style>
      tr:nth-child(odd) { background-color: lightgrey } 
    </style>
  </head>
  <body onload="init()">
    <h1>Colis</h1>
    <form action="#res">
      <div class="weight"><label for="weight">Poids (kg)</label> <input type="number" id="weight" min="0.1" step="0.1" required /></div>
      <div class="size">
        <label for="length">Longueur (cm)</label> <input type="number" id="length" min="1" required />
        <label for="width">Largeur (cm)</label> <input type="number" id="width" min="1" required />
        <label for="height">Hauteur (cm)</label> <input type="number" id="height" min="1" required />
      </div>
    </form>
    <h1><a name="res" />Offres</h1>
    <table>
      <thead>
        <tr>
          <th>Livreur</th>
          <th>Relais</th>
          <th>Tarif</th>
          <th>Assurance</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </body>
</html>
