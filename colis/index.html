<html>
  <head>
    <title>Estimation frais de port</title>
    <script>
      fetch("data/tarif.json").then(async j => {
        const tarifs = await j.json();
        document.querySelector("form").submit=(event) => {
          const length = parseFloat(document.querySelector("input#length").value);
          const width = parseFloat(document.querySelector("input#width").value);
          const height = parseFloat(document.querySelector("input#height").value);
          const weight = parseFloat(document.querySelector("input#weight").value);
          const result = [];
          tarifs
            .filter(t => { return t.r === null || ( ( t.r.maxL     === null || t.r.maxL     >= length ) 
                                                 && ( t.r.maxW     === null || t.r.maxW     >= width  ) 
                                                 && ( t.r.maxH     === null || t.r.maxH     >= height )
                                                 && ( t.r.maxLWH   === null || t.r.maxLWH   >= length + width + height )
                                                 && ( t.r.maxL2W2H === null || t.r.maxL2W2H >= length + (2 * width) + (2 * height) ) ); })
            .forEach(offre => {
              offres: {
                offre.t.forEach( t => {
                  for( p in t.t ) {
                    if( p >= weight ) {
                      result.push({ "n" : offre.n, "h": offre.h, "t": JSON.stringify(t.t[p]) });
                      break offres;
                    }
                  }
                });
              }
          });
          const domArray = document.querySelector("tbody");
          while(domArray.hasChildNodes()) { domArray.removeChild(domArray.firstChild); }
          tarifs
            .sort( (a,b) => { return a.t - b.t; })
            .forEach(t => {
              const tr = document.createElement("tr");
              const td1 = document.createElement("td");
              td1.appendChild(document.createTextNode(t.n));
              tr.appendChild(td1);
              const td2 = document.createElement("td");
              td2.appendChild(document.createTextNode(t.h?"à l maison":"en relais"));
              tr.appendChild(td2);
              const td3 = document.createElement("td");
              td3.appendChild(document.createTextNode(t.t));
              tr.appendChild(td3);
              domArray.appendChild(tr);
            });
          return false;
        };
      });
    </script>
  </head>
  <body>
    <h1>Format du Colis</h1>
    <form action="#">
      <label for="weight">Poids (kg)</label> <input type="number" id="weight" min="0.1" step="0.1" required />
      <label for="length">Longueur (cm)</label> <input type="number" id="length" min="1" required />
      <label for="width">Largeur (cm)</label> <input type="number" id="width" min="1" required />
      <label for="height">Hauteur (cm)</label> <input type="number" id="height" min="1" required /> 
      <input type="submit" value="Calculer" />
    </form>
    <h1>Résultats</h1>
    <table>
      <thead>
        <tr>
          <th>Livreur</th>
          <th>Relais</th>
          <th>Tarif</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </body>
</html>
