name: Fetch tarifs
on:
  workflow_dispatch:
jobs:
  mondialrelay:    
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: init env
      run: |
        pip install undetected-chromedriver
    - name: Fetch
      run: |
        python <<EOF
        import undetected_chromedriver as uc
        driver = uc.Chrome(headless=True,use_subprocess=False)
        driver.get('https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/')
        with open('/tmp/mondialrelay.html', 'w') as file:
            file.write(driver.page_source)
        driver.quit()
        EOF
    - name: Parse
        git config --local user.name "xavier.forestier"
        git config --local user.email "{ID}+{username}@users.noreply.github.com"
        git fetch
        git switch main
        cat /tmp/mondialrelay.html
        echo "[" > colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais (lockers)\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":64,\"maxW\":41,\"maxH\":38},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( tail /tmp/mondialrelay.html -n +$(( $i + 1 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . )}"; done |cut -c2- )]}," >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( tail /tmp/mondialrelay.html -n +$(( $i + 2 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . )}"; done |cut -c2- )]}," >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":true,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( tail /tmp/mondialrelay.html -n +$(( $i + 3 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . )}"; done |cut -c2- )]}," >> colis/data/mondialrelais.json      
        echo "{\"n\":\"Mondial Relais R1 (lockers)\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":64,\"maxW\":41,\"maxH\":38},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 1 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 2 )}"; done |cut -c2- )],\"a\":{\"f\":50}},"    >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R1\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo $( tail /tmp/mondialrelay.html -n +$(( $i + 2 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 2 )}"; done |cut -c2- )],"a": { "f": 50 }},"                       >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R1\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":true,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 3 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 2)}"; done |cut -c2- )],"a": { "f": 50 }},"                        >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R2 (lockers)\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":64,\"maxW\":41,\"maxH\":38},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 1 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 3.5 )}"; done |cut -c2- )],\"a\":{\"f\":125}}," >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R2\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo $( tail /tmp/mondialrelay.html -n +$(( $i + 2 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 3.5 )}"; done |cut -c2- )],\"a\":{\"f\":125}},"                    >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R2\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":true,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 3 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 3.5 )}"; done |cut -c2- )],\"a\":{\"f\":125}},"                    >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R3 (lockers)\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":64,\"maxW\":41,\"maxH\":38},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 1 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 5 )}"; done |cut -c2- )],\"a\":{\"f\":250}},"   >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R3\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo $( tail /tmp/mondialrelay.html -n +$(( $i + 2 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 5 )}"; done |cut -c2- )],\"a\":{\"f\":250}},"                      >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R3\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":true,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 3 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 5 )}"; done |cut -c2- )],\"a\":{\"f\":250}},"                      >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R4 (lockers)\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":64,\"maxW\":41,\"maxH\":38},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 1 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 6.5 )}"; done |cut -c2- )],\"a\":{\"f\":375}}," >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R4\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo $( tail /tmp/mondialrelay.html -n +$(( $i + 2 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 6.5 )}"; done |cut -c2- )],\"a\":{\"f\":375}},"                    >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R4\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":true,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 3 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 6.5 )}"; done |cut -c2- )],\"a\":{\"f\":375}},"                    >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R5 (lockers)\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":64,\"maxW\":41,\"maxH\":38},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 1 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 8 )}"; done |cut -c2- )],\"a\":{\"f\":500}},"   >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R5\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":false,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo $( tail /tmp/mondialrelay.html -n +$(( $i + 2 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 8 )}"; done |cut -c2- )],\"a\":{\"f\":500}},"                      >> colis/data/mondialrelais.json
        echo "{\"n\":\"Mondial Relais R5\",\"u\":\"https://www.mondialrelay.fr/envoi-de-colis/tarifs-expeditions/\",\"relais\":\"https://www.mondialrelay.fr/trouver-le-point-relais-le-plus-proche-de-chez-moi/\",\"h\":true,\"r\":{\"maxL\":120,\"maxLWH\":150},\"t\":[$( for i in $(head -n `grep -n "<h2>" /tmp/mondialrelay.html | grep "international" | cut -d: -f1` /tmp/mondialrelay.html  | grep \"Poids -n | cut -d: -f1);do echo -n ",{\"$( echo "scale=0; $( tail /tmp/mondialrelay.html -n +$i | head -n1 | cut -d\> -f2 | cut -d\< -f1 | cut -dK -f1 | tr , . ) * 1000 / 1" | bc )\":$( echo "$( tail /tmp/mondialrelay.html -n +$(( $i + 3 )) | head -n1 | cut -d\> -f2 | tr "€" "<"| cut -d\< -f1 | tr , . ) + 8 )}"; done |cut -c2- )],\"a\":{\"f\":500}}"                      >> colis/data/mondialrelais.json
        echo "]" >> colis/data/mondialrelais.json
        git add colis/data/mondialrelais.json
        git commit -m "Update price" || true
        git push --force-with-lease
        git push
